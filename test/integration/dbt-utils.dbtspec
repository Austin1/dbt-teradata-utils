target:
  type: teradata
  server: "{{ env_var('DBT_TERADATA_SERVER_NAME', 'localhost') }}"
  username: "{{ env_var('DBT_TERADATA_USERNAME', 'dbc') }}"
  password: "{{ env_var('DBT_TERADATA_PASSWORD', 'dbc') }}"
  schema: "dbt_test_{{ var('_dbt_random_suffix') }}"
  tmode: ANSI
  log: "0"

projects:
  - name: validate_equal_rowcount_positive
    paths:
      packages.yml: |
        packages:
        - package: dbt-labs/dbt_utils
          version: 0.8.0

      models/schema.yml: |
        version: 2
        models:
          - name: test_table1
            tests:
              - dbt_utils.equal_rowcount:
                  compare_model: ref('test_table2')

      seeds/test_table1.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B
        4,val4A,val4B

      seeds/test_table2.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B
        4,val4A,val4B

  - name: validate_equal_rowcount_negative
    paths:
      packages.yml: |
        packages:
        - package: dbt-labs/dbt_utils
          version: 0.8.0

      models/schema.yml: |
        version: 2
        models:
          - name: test_table1
            tests:
              - dbt_utils.equal_rowcount:
                  compare_model: ref('test_table2')

      seeds/test_table1.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B
        4,val4A,val4B

      seeds/test_table2.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B

  - name: validate_equal_fewer_rows_than_positive
    paths:
      dbt_project.yml: |
        name: 'validate_equal_fewer_rows_than_positive'
        version: '1.0.0'
        config-version: 2
        dispatch:
          - macro_namespace: dbt_utils
            search_order:
              - teradata_utils
              - dbt_utils

      packages.yml: |
        packages:
        - package: dbt-labs/dbt_utils
          version: 0.8.0
        - local: "{{ env_var('DBT_TERADATA_UTILS_ROOT') }}"

      models/schema.yml: |
        version: 2
        models:
          - name: test_table1
            tests:
              - dbt_utils.fewer_rows_than:
                  compare_model: ref('test_table2')

      seeds/test_table1.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B

      seeds/test_table2.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B
        4,val4A,val4B

  - name: validate_equal_fewer_rows_than_negative
    paths:

      dbt_project.yml: |
        name: 'validate_equal_fewer_rows_than_negative'
        version: '1.0.0'
        config-version: 2
        dispatch:
          - macro_namespace: dbt_utils
            search_order:
              - teradata_utils
              - dbt_utils
      packages.yml: |
        packages:
        - package: dbt-labs/dbt_utils
          version: 0.8.0
        - local: "{{ env_var('DBT_TERADATA_UTILS_ROOT') }}"

      models/schema.yml: |
        version: 2
        models:
          - name: test_table1
            tests:
              - dbt_utils.fewer_rows_than:
                  compare_model: ref('test_table2')

      seeds/test_table1.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B
        4,val4A,val4B

      seeds/test_table2.csv: |
        id,attrA,attrB
        1,val1A,val1B
        2,val2A,val2B
        3,val3A,val3B
        4,val4A,val4B

sequences:

  test_validate_equal_rowcount_positive:
    project: validate_equal_rowcount_positive
    sequence:
      - type: dbt
        cmd: deps
      - type: dbt
        cmd: seed
      - type: run_results
        exists: True
      - type: dbt
        cmd: test
      - type: run_results
        exists: True

  test_validate_equal_rowcount_negative:
    project: validate_equal_rowcount_negative
    sequence:
      - type: dbt
        cmd: deps
      - type: dbt
        cmd: seed
      - type: run_results
        exists: True
      - type: dbt
        cmd: test
        check: false
      - type: run_results
        exists: True
        length: 1
        attributes:
          dbt_utils_equal_rowcount_test_table1_ref_test_table2_.status: fail

  test_validate_equal_fewer_rows_than_positive:
    project: validate_equal_fewer_rows_than_positive
    sequence:
      - type: dbt
        cmd: deps
      - type: dbt
        cmd: seed
      - type: run_results
        exists: True
      - type: dbt
        cmd: test
      - type: run_results
        exists: True
        length: 1
        attributes:
          dbt_utils_fewer_rows_than_test_table1_ref_test_table2_.status: pass

  test_validate_equal_fewer_rows_than_negative:
    project: validate_equal_fewer_rows_than_negative
    sequence:
      - type: dbt
        cmd: deps
      - type: dbt
        cmd: seed
      - type: run_results
        exists: True
      - type: dbt
        cmd: test
        check: false
      - type: run_results
        exists: True
        length: 1
        attributes:
          dbt_utils_fewer_rows_than_test_table1_ref_test_table2_.status: fail
